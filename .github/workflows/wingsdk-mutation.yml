name: WingSDK Mutation

on:
  pull_request_target:
    types:
      - opened
      - synchronize
    paths:
      - libs/wingsdk/**

permissions:
  contents: write

defaults:
  run:
    working-directory: libs/wingsdk

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      self_mutation_happened: ${{ steps.self_mutation.outputs.self_mutation_happened }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Login to private npm registry
        run: npm config set @winglang:registry https://npm.pkg.github.com && npm set //npm.pkg.github.com/:_authToken ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
      - name: Build transitive dependency (wing-api-checker)
        run: npm install && npm run build
        working-directory: apps/wing-api-checker
      - name: Build transitive dependency (jsii-docgen)
        run: npm install && npm run build
        working-directory: apps/jsii-docgen
      - name: Install dependencies
        run: npm install
      - name: build
        run: npx projen build
      - id: self_mutation
        name: Find mutations
        run: |-
          git add .
          git diff --staged --patch --exit-code || echo "::set-output name=self_mutation_happened::true"
      - name: Upload patch
        if: steps.self_mutation.outputs.self_mutation_happened
        uses: actions/upload-artifact@v2
        with:
          name: .repo.patch
          path: libs/wingsdk/.repo.patch
      - name: Set git identity
        if: steps.self_mutation.outputs.self_mutation_happened
        run: |-
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      - name: Push changes
        if: steps.self_mutation.outputs.self_mutation_happened
        run: |-
          git add .
          git commit -s -m "chore: self mutation"
          git push origin HEAD:${{ github.event.ref }}
      - name: Fail build on mutation
        if: steps.self_mutation.outputs.self_mutation_happened
        run: |-
          echo "::error::Files were changed during build (see build log)."
          exit 1
